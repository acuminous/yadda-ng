<pre>




                                                                                                                                                                                                                                                                      ┌──────────────────────────────────────────────┐
                                                                                                                                                                                                                                                                      │                    State                     │                                                               ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
                                                                                                                                                                                                                                                                      ├──────────────────────────────────────────────┤                                                               │                                           <<Step>>                                           │
                                                                                                                                                                                                                                                                      │State()                                       │                                                               ├──────────────────────────────────────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                      ├──────────────────────────────────────────────┤                                                               │text: String                                                                                  │
                                                                                                                                                                                                                                                                      │                                              │                                                               │generalised: String                                                                           │
                                                                                                                                                                                                                                                                      ├──────────────────────────────────────────────┤                                                               │docString: String                                                                             │
                                                                                                                                                                                                                                                                      │get(name: String, scope: Scope =              │                                                               ├──────────────────────────────────────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                      │SCENARIO_SCOPE): Any                          │                                                               │hasAnnotation(name: String): Boolean                                                          │
                                                                                                                                                                                                                                                                      │set(name: String, value: Any, scope: Scope =  │                                                               │getAnnotation(name: String): Annotation                                                       │
                                                                                                                                                                                                                                                                      └──────────────────────────────────────────────┘                                                               │isPending(): Boolean                                                                          │
                                                                                                                                                                                                                                                                                                                                                                                     │isExclusive(): Boolean                                                                        │
                                                                                                                                                                                                                                                                                                                                                                                     │isAborted(): Boolean                                                                          │
                                                                                                                                                                                                                                                                                                                                                                                     │abort(): Step<T>                                                                              │
                                                                                                                                                                                                                                                                                                                                                                                     └──────────────────────────────────────────────────────────────────────────────────────────────┘
                                                                                                                                                                                                                                                                                                                                                                                                                                     △

                                                                                                                                                                                                                                                                                                                                                                                                                                     │

                                                                                                                                                                                                                                                                                                                                                                                                                                     │
                                                                                                                                                                                                                                                    ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
                                                                                                                                                                                                                                                    │                                           Scenario                                           │                                                                                 │
                                                                                               ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐                                              ├──────────────────────────────────────────────────────────────────────────────────────────────┤                                 ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
                                                                                               │                                               Feature                                               │                                              │Scenario({ annotations: Annotations = new Annotations(), title: String, steps: Array<Step> }) │                                 │                                           BaseStep                                           │
                                                                                               ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤                                              ├──────────────────────────────────────────────────────────────────────────────────────────────┤                                 ├──────────────────────────────────────────────────────────────────────────────────────────────┤
                                                                                               │Feature({ annotations: Annotations = new Annotations(), title: String, scenarios: Array<Scenario> }) │                                              │title: String                                                                                 │                                 │ BaseStep({ annotations: Annotations, text: String, generalised: String, docString: String }) │
                              ┌───────────────────────────────┐                                ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤                                              ├──────────────────────────────────────────────────────────────────────────────────────────────┤                                 ├──────────────────────────────────────────────────────────────────────────────────────────────┤
                              │        FeaturePlaybook        │                                │title: String                                                                                        │                                              │hasAnnotation(name: String): Boolean                                                          │                                 │text: String                                                                                  │
                              ├───────────────────────────────┤                                ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤                                              │getAnnotation(name: String): Annotation                                                       │                                 │generalised: String                                                                           │
                              │FeaturePlaybook({ features })  │                                │hasAnnotation(name: String): Boolean                                                                 │                                              │isPending(): Boolean                                                                          │                                 │docString: String                                                                             │
                              ├───────────────────────────────┤                               ╱│getAnnotation(name: String): Annotation                                                              │                                             ╱│isExclusive(): Boolean                                                                        │                                ╱├──────────────────────────────────────────────────────────────────────────────────────────────┤
                              │                               │────────────────────────────────│isPending(): Boolean                                                                                 │──────────────────────────────────────────────│isAborted(): Boolean                                                                          │─────────────────────────────────│hasAnnotation(name: String): Boolean                                                          │
                              ├───────────────────────────────┤                               ╲│isExclusive(): Boolean                                                                               │                                             ╲│abort(): Void                                                                                 │                                ╲│getAnnotation(name: String): Annotation                                                       │
                              │find(cb)                       │                                │find(cb)                                                                                             │                                              │find(cb)                                                                                      │                                 │isPending(): Boolean                                                                          │
                              │filter(cb)                     │                                │filter(cb)                                                                                           │                                              │filter(cb)                                                                                    │                                 │isExclusive(): Boolean                                                                        │
                              │forEach(cb)                    │                                │forEach(cb)                                                                                          │                                              │forEach(cb)                                                                                   │                                 │isAborted(): Boolean                                                                          │
                              │map(cb)                        │                                │map(cb)                                                                                              │                                              │map(cb)                                                                                       │                                 │abort(): BaseStep<T>                                                                          │
                              │reduce(cb)                     │                                │reduce(cb)                                                                                           │                                              │reduce(cb)                                                                                    │                                 └──────────────────────────────────────────────────────────────────────────────────────────────┘
                              │run(state: State)              │                                └─────────────────────────────────────────────────────────────────────────────────────────────────────┘                                              └──────────────────────────────────────────────────────────────────────────────────────────────┘                                                                                 △
                              └───────────────────────────────┘                                                                                   │                                                                                                                                                 │                                                                                                                                │
                                                                                                                                                  │                                                                                                                                                 │                                                                                                                                │
                                                                                                                                                  │                                                                                                                                                 │                                                                                                                                │
                                                                                                                                                  │                                                                                                                                                 │                                                                                                                                │
                                                                                                                                                  │                                                                                                                                                 │                                                                                                                                │
                                                                                                                                                  │                                                                                                                                                 │                                                                                                                                │
                                                                                                                                                  │                                                 ┌──────────────────────────────────────────────────────┐                                        │                                                                                                                                │
                                                                                                                                                  │                                                 │                     Annotations                      │                                        │                                                    ┌───────────────────────────────────────────────────────────────────────┬───┴─────────────────────────────────────┬──────────────────────────────┐
                                                                                                                                                  │                                                 ├──────────────────────────────────────────────────────┤                                        │                                                    │                                                                       │                                         │                              │
                                                                                                                                                  │                                                 │Annotations({ annotations: Array<Annotation> = [] })  │                                        │                                                    │                                                                       │                                         │                              │
                                                                                                                                                  │                                                 ├──────────────────────────────────────────────────────┤                                        │                                                    │                                                                       │                                         │                              │
                                                                                                                                                  └─────────────────────────────────────────────────│                                                      │◀───────────────────────────────────────┘                                                    │                                                                       │                                         │                              │
                                                                                                                                                                                                    ├──────────────────────────────────────────────────────┤                                                                                             │                                                                       │                                         │                              │
                                                                                                                                                                                                    │has(name: String): Boolean                            │                                                                                             │                                                                       │                                         │                              │
                                                                                                                                                                                                    │get(name: String): Annotation                         │                                                                                             │                                                                       │                                         │                              │
                                                                                                                                                                                                    │add(name: String, value: Any): Annotations            │                                                                                             │                                                                       │                                         │                              │                                                                                                    ┌──────────────────────────────────────────────────────────────┐
                                                                                                                                                                                                    └──────────────────────────────────────────────────────┘                                                                                             │                                                                       │                                         │                              │                                                                                                    │                          FixedArity                          │
                                                                                                                                                                                                                                │                                                                         ┌────────────────────────────────────────────────────────────────────────────────────────────┐   ┌───────────────────────────────────────────┐   ┌──────────────────────────────┐   ┌───────────────────────┐                                                                                        ├──────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                │                                                                         │                                        DynamicStep                                         │   │               AmbiguousStep               │   │         RunnableStep         │   │     UndefinedStep     │           ┌───────────────────────────────────────────────────────────────────────────▶│                                                              │
                                                                                                                                                                                                                                │                                                                         ├────────────────────────────────────────────────────────────────────────────────────────────┤   ├───────────────────────────────────────────┤   ├──────────────────────────────┤   ├───────────────────────┤           │                                                                            ├──────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                │                                                                         │DynamicStep({ libraries: Libraries, text: String, generalised: String, docString: String }) │   │AmbiguousStep({ contenders: Array<Macro> })│   │RunnableStep({ macro: Macro })│   │UndefinedStep()        │           │                                                                            │validate({ step: Step, supply: Number, demand: Number }): Void│
                                                                                                                                                                                                                                │                                                                         ├────────────────────────────────────────────────────────────────────────────────────────────┤   ├───────────────────────────────────────────┤   ├──────────────────────────────┤   ├───────────────────────┤           │                                                                            │                                                              │
                                                                                                                                                                                                                                │                                                                         │                                                                                            │   │                                           │   │                              │   │                       │           │                                                                            └──────────────────────────────────────────────────────────────┘
                                                                                                                                                                                                                                │                                                                         ├────────────────────────────────────────────────────────────────────────────────────────────┤   ├───────────────────────────────────────────┤   ├──────────────────────────────┤   ├───────────────────────┤           │
                                                                                                                                                                                                                                │                                                                         │isPending(): Boolean                                                                        │   │+abort(): AmbiguousStep                    │   │isPending(): Boolean          │   │abort(): UndefinedStep │           │
                                                                                                                                                                                                                                │                                                                         │run(): Any                                                                                  │   │+run(): Any                                │   │run(state: State): Any        │   │suggest(): String      │           │
                                                                                                                                                                                                                               ╱│╲                                                                        └────────────────────────────────────────────────────────────────────────────────────────────┘   └───────────────────────────────────────────┘   └──────────────────────────────┘   │run(): Any             │           │
                                                                                                                                                                                                           ┌─────────────────────────────────────────┐                                                                                                   │                                                                                                                 │                  └───────────────────────┘           │
                                                                                                                                                                                                           │               Annotation                │                                                                                                                                                                                                                     │                                                      │                                                                            ┌────────────────────────────────────────────────┐
                                                                                                                                                                                                           ├─────────────────────────────────────────┤                                                                                                   │                                                                                                                 │                                                      │                                                                            │                 <<Converter>>                  │
                                                                                                                                                                                                           │Annotation({ name: String, value: Any }) │                                                                                                                                                                                                                     │                                                      │                                                                           ╱├────────────────────────────────────────────────┤
                                                                                                                                                                                                           ├─────────────────────────────────────────┤                                                                           ┌──────────────────────────────────────────────┐                                                                                          │                                                      │                                                          ┌─────────────────│demand(): Number                                │
                                                                                                                                                                                                           │boolean: Boolean                         │                                                                           │                 Competition                  │                                                                                          │                                                      │                                                          │                ╲├────────────────────────────────────────────────┤
                                                                                                                                                                                                           │number: Number                           │                                                                           ├──────────────────────────────────────────────┤                                                                                          │                                                      │                                                          │                 │convert(state: State, value: Any): Promise<Any> │
                                                                                                                                                                                                           │string: String                           │                                                                           │Competition                                   │                                                                                          │                                                      │                                                          │                 └────────────────────────────────────────────────┘
                                                                                                                                                                                                           │date: Date                               │                                                                           ├──────────────────────────────────────────────┤                                                                                          │                                                      │                                                          │
                                                                                                                                                                                                           │value: <Any>                             │                                                                           │                                              │                                                                                          │                                                      │                                                          │
                                                                                                                                                                                                           │values: Array[<Any>]                     │                                                                           ├──────────────────────────────────────────────┤                                                                                          │                                                      │                                                          │
                                                                                                                                                                                                           ├─────────────────────────────────────────┤                                                                           │rank(state: State, candidates): Array<Step>   │                                                                                          │                                                      │                                                          │
                                                                                                                                                                                                           │answersTo(name: String): Boolean         │                                                                           └──────────────────────────────────────────────┘                                                                                          │                                                      │                                                          │
                                                                                                                                                                                                           │set(value: Any): Void                    │                                                                                                                                                                                                                     │                                                      │                                                          │
                                                                                                                                                                                                           │add(value: Any): Void                    │                                                                                                                                                                                                                     │                                                      │                                                          │
                                                                                                                                                                                                           └─────────────────────────────────────────┘                                                                                                                                                                                                                     │                                                      │                                                          │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           │            ┌───────────────────────────────────────────────────────────────────────────────────┐                │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           │            │                                       Macro                                       │                │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           │            ├───────────────────────────────────────────────────────────────────────────────────┤                │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           │            │Macro({ signature: Signature, converters: Array<Converter>, fn: Callable })        │                │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           │            ├───────────────────────────────────────────────────────────────────────────────────┤                │
                                                                                                                                                                                                                                                                                                   ┌──────────────────────────────────────────────┐                 ┌────────────────────────────────────────────────────────────────────────────────────┐                 └───────────▶│                                                                                   │────────────────┘                            ┌────────────────────────────────────────────────────┐
                                                                                                                                                                                                                                                                                                   │                  Libraries                   │                 │                                      Library                                       │                              ├───────────────────────────────────────────────────────────────────────────────────┤                                             │                    <<Callable>>                    │
                                                                                                                                                                                                                                                                                                   ├──────────────────────────────────────────────┤                 ├────────────────────────────────────────────────────────────────────────────────────┤                              │supports(step: Step): Boolean                                                      │                                             ├────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                   │Libraries({ libraries: Array<Library> })      │                 │Library({ name: String, dictionaries: Array<Dictionary> = [] })                     │                              │isPending(): Boolean                                                               │────────────────────────────────────────────▶│                                                    │
                                                                                                                                                                                                                                                                                                   ├──────────────────────────────────────────────┤                ╱├────────────────────────────────────────────────────────────────────────────────────┤                            ╱ │setCurrentLibrary(state: State): Void                                              │                                             ├────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                   │                                              │─────────────────│name: String                                                                        │───────────────────────────── │isFromLibrary(name: String): Boolean                                               │                                             │isPending(): Boolean                                │
                                                                                                                                                                                                                                                                                                   ├──────────────────────────────────────────────┤                ╲├────────────────────────────────────────────────────────────────────────────────────┤                            ╲ │reportDuplicate(other: Macro): Void                                                │                                             │run(state: State, args: Array<Any>): Promise<Any>   │
                                                                                                                                                                                                                                                                                                   │select(names: Array<String> = []): Libraries  │                 │getCompatibleMacros(step: Step): Array<Macro>                                       │                              │run(state: State, step: Step): Promise<Any>                                        │                                             └────────────────────────────────────────────────────┘
                                                                                                                                                                                                                                                                                                   │add(library: Library): Libraries              │                 │define(signatures: Array<Template | RegExp>, fn: Callable, options: Map }): Library │                              └───────────────────────────────────────────────────────────────────────────────────┘                                                                        △
                                                                                                                                                                                                                                                                                                   │getCompatibleMacros(step: Step): Array<Macro> │                 │define(signatures: Template | RegExp, fn: Callable, options: Map }): Library        │                                                                        │                                                                                                                  │
                                                                                                                                                                                                                                                                                                   └──────────────────────────────────────────────┘                 └────────────────────────────────────────────────────────────────────────────────────┘                                                                        │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │                                                          ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │                                                          │                                                       │                                                       │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │                                                          │                                                       │                                                       │
                                                                                                                                                                                                                                                                                                                                                                                                               ▼                                                                                                                  │                                ┌──────────────────────────────────────────────────┐    ┌──────────────────────────────────────────────────┐    ┌──────────────────────────────────────────────────┐
                                                                                                                                                                                                                                                                                                                                                                  ┌─────────────────────────────────────────────────────────────────────────────────────────┐                                                                     │                                │                  AsyncFunction                   │    │                 CallbackFunction                 │    │                 PendingFunction                  │
                                                                                                                                                                                                                                                                                                                                                                  │                                       Dictionary                                        │                                                                     │                                ├──────────────────────────────────────────────────┤    ├──────────────────────────────────────────────────┤    ├──────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                  ├─────────────────────────────────────────────────────────────────────────────────────────┤                                                                     │                                │AsyncFunction({ fn: Function })                   │    │CallbackFunction({ fn: Function })                │    │PendingFunction()                                 │
                                                                                                                                                                                                                                                                                                                                                                  │Dictionary({ prefix: String, delimiter: String })                                        │                                                                     │                                ├──────────────────────────────────────────────────┤    ├──────────────────────────────────────────────────┤    ├──────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                  ├─────────────────────────────────────────────────────────────────────────────────────────┤                                                                     │                                │demand: Number                                    │    │demand: Number                                    │    │                                                  │
                                                                                                                                                                                                                                                                                                                                                                  │                                                                                         │                                                                     │                                ├──────────────────────────────────────────────────┤    ├──────────────────────────────────────────────────┤    ├──────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                  ├─────────────────────────────────────────────────────────────────────────────────────────┤                                                                     │                                │isPending(): Boolean                              │    │isPending(): Boolean                              │    │isPending(): Boolean                              │
                                                                                                                                                                                                                                                                                                                                                                  │combine(other: Dictionary): Dictionary                                                   │                                                                     │                                │run(state: State, args: Array<Any>): Promise<Any> │    │run(state: State, args: Array<Any>): Promise<Any> │    │run(state: State, args: Array<Any>): Promise<Any> │
                                                                                                                                                                                                                                                                                                                                                                  │define(expression: String, definition: RegExp, converters: Array<Converter>): Dictionary │                                                                     │                                └──────────────────────────────────────────────────┘    └──────────────────────────────────────────────────┘    └──────────────────────────────────────────────────┘
                                                                                                                                                                                                                                                                                                                                                                  │defines(expression : String): Boolean                                                    │                                                                     │
                                                                                                                                                                                                                                                                                                                                                                  └─────────────────────────────────────────────────────────────────────────────────────────┘                                                                     │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               ┼                                                                                                                  ▼
                                                                                                                                                                                                                                                                                                                                                                                                              ╱│╲                                                                              ┌─────────────────────────────────────────────────────────────────────┐
                                                                                                                                                                                                                                                                                                                                                                                       ┌──────────────────────────────────────────────┐                                                        │                              Signature                              │
                                                                                                                                                                                                                                                                                                                                                                                       │                     Term                     │                                                        ├─────────────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                                       ├──────────────────────────────────────────────┤                                                        │ Signature({ library: Library, template: String, pattern: Pattern }) │
                                                                                                                                                                                                                                                                                                                                                                                       │Term({ expression: String, definition: RegExp │                                                        ├─────────────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                                       ├──────────────────────────────────────────────┤                                                        │                                                                     │
                                                                                                                                                                                                                                                                                                                                                                                       │definition: String                            │                                                        ├─────────────────────────────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                                       │converters: Array<Converter>                  │                                                        │supports(step: Step): Boolean                                        │
                                                                                                                                                                                                                                                                                                                                                                                       ├──────────────────────────────────────────────┤                                                        │setCurrentLibrary(state): Void                                       │
                                                                                                                                                                                                                                                                                                                                                                                       │resolves(expression): Boolean                 │                                                        │isFromLibrary(name): Boolean                                         │
                                                                                                                                                                                                                                                                                                                                                                                       │                                              │                                                        │reportDuplicate(other: Signature): Void                              │
                                                                                                                                                                                                                                                                                                                                                                                       │                                              │                                                        │parseArguments(step: Step): Array<String>                            │
                                                                                                                                                                                                                                                                                                                                                                                       └──────────────────────────────────────────────┘                                                        └─────────────────────────────────────────────────────────────────────┘
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  │
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                                                  ▼
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ┌──────────────────────────────────────────────┐
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                          │                   Pattern                    │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ├──────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                                                               │                                                                                          │Pattern(template: String, directives: String) │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ├──────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                                                               └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                              │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ├──────────────────────────────────────────────┤
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          │equals(other: RegExp): Boolean                │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          │countMatchingRegExpGroups(): Number           │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          │supports(text: String): Boolean               │
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          └──────────────────────────────────────────────┘</pre>
